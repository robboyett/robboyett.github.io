<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line It Up</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        #game-screen, #scoreboard, #result-screen, #mode-selection {
            display: none;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        #bar-container {
            width: 100%;
            height: 30px;
            border: 2px solid black;
            margin: 20px 0;
            position: relative;
            background-color: #f0f0f0;
        }

        #bar {
            width: 10%;
            height: 100%;
            background-color: red;
            position: absolute;
        }

        #stop-button {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }

        #scoreboard {
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .slider-container {
            margin: 20px 0;
        }

        #speed-slider {
            width: 100%;
        }

        .slider-label {
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="landing-page">
    <h1>Line It Up</h1>
    <button onclick="showModeSelection()">Start Game</button>
</div>

<div id="mode-selection" class="container">
    <h2>Select Mode</h2>
    <button onclick="startGame(1)">One Player</button>
    <button onclick="startGame(2)">Two Player</button>
    <div class="slider-container">
        <label for="speed-slider" class="slider-label">Choose Starting Speed:</label>
        <input type="range" id="speed-slider" min="1" max="5" step="1" value="3" />
        <div id="speed-label">Fox (Normal)</div>
    </div>
</div>

<div id="game-screen" class="container">
    <h2 id="round-info"></h2>
    <div id="bar-container">
        <div id="bar"></div>
    </div>
    <button id="stop-button" onclick="stopBar()">Stop</button>
    <h3 id="player-info"></h3>
    <h3 id="score-info">Score: 0</h3>
</div>

<div id="result-screen" class="container">
    <h2>Game Over!</h2>
    <h3 id="final-score"></h3>
    <button onclick="restartGame()">Play Again</button>
</div>

<script>
    let bar = document.getElementById('bar');
    let roundInfo = document.getElementById('round-info');
    let scoreInfo = document.getElementById('score-info');
    let playerInfo = document.getElementById('player-info');
    let finalScore = document.getElementById('final-score');
    let speedSlider = document.getElementById('speed-slider');
    let speedLabel = document.getElementById('speed-label');

    let isPlaying = false;
    let barSpeed = 2; // Initial speed for the bar
    let barDirection = 1;
    let currentPosition = 0;

    let mode = 1; // 1 for one-player, 2 for two-player
    let round = 1;
    const totalRounds = 5;

    let playerTurn = 1; // 1 or 2
    let scores = { player1: 0, player2: 0 };

    function showModeSelection() {
        document.getElementById('landing-page').style.display = 'none';
        document.getElementById('mode-selection').style.display = 'block';
    }

    function updateSpeedLabel() {
        const speedNames = ["Snail (Super Easy)", "Chicken (Easy)", "Fox (Normal)", "Car (Hard)", "Rocket (Impossible)"];
        const speedValues = [2, 4, 6, 8, 10];
        const index = parseInt(speedSlider.value) - 1;
        speedLabel.textContent = speedNames[index];
        barSpeed = speedValues[index];
    }

    speedSlider.addEventListener('input', updateSpeedLabel);

    function startGame(selectedMode) {
        mode = selectedMode;
        document.getElementById('mode-selection').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        resetRound();
    }

    function resetRound() {
    if (round > totalRounds && mode === 1) {
        endGame();
        return;
    }

    // Switch to Player 2 after Player 1 completes all rounds
    if (round > totalRounds && mode === 2 && playerTurn === 1) {
        playerTurn = 2; // Switch to Player 2
        round = 1; // Reset round counter for Player 2
        // Remove the barSpeed reset here to carry forward progression
    } else if (round > totalRounds && mode === 2 && playerTurn === 2) {
        endGame();
        return;
    }

    roundInfo.textContent = `Round ${round} of ${totalRounds}`;
    if (mode === 2) {
        playerInfo.textContent = `Player ${playerTurn}'s Turn`;
    }

    startBar(); // Start the bar animation
}

    let animationId; // Holds the ID of the current animation frame

function startBar() {
    // Cancel any existing animation
    if (animationId) {
        cancelAnimationFrame(animationId);
    }

    // Reset bar state
    isPlaying = true;
    currentPosition = 0;
    bar.style.left = currentPosition + '%';
    barDirection = 1;
    scoreInfo.textContent = `Score: ${scores[`player${playerTurn}`]}`;

    // Start the animation
    animationId = requestAnimationFrame(animateBar);
}

function animateBar() {
    if (!isPlaying) return;

    // Update the bar's position
    currentPosition += barDirection * barSpeed * 0.1;

    // Reverse direction if hitting the edges
    if (currentPosition >= 90 || currentPosition <= 0) {
        barDirection *= -1;
    }

    // Apply the new position
    bar.style.left = currentPosition + '%';

    // Request the next animation frame
    animationId = requestAnimationFrame(animateBar);
}

function stopBar() {
    if (!isPlaying) return;
    isPlaying = false;

    let center = 45; // Midpoint range
    let goldRange = 5; // 10% total width (5% either side)
    let silverRange = 12.5;
    let bronzeRange = 15;

    let distanceFromCenter = Math.abs(currentPosition - center);
    let points = 0;

    if (distanceFromCenter <= goldRange) {
        points = 10;
    } else if (distanceFromCenter <= goldRange + silverRange) {
        points = 5;
    } else if (distanceFromCenter <= goldRange + silverRange + bronzeRange) {
        points = 2;
    }

    scores[`player${playerTurn}`] += points;
    alert(`Player ${playerTurn} scored ${points} points!`);

    round++;
    if (mode === 2 && playerTurn === 1 && round > totalRounds) {
        playerTurn = 2; // Switch to Player 2
        round = 1; // Reset rounds for Player 2
        barSpeed = parseFloat(speedSlider.value); // Reset to initial speed for Player 2
    }
    resetRound();
}

    function endGame() {
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';

        if (mode === 1) {
            finalScore.textContent = `Your final score: ${scores.player1}`;
        } else {
            let winner =
                scores.player1 > scores.player2
                    ? "Player 1 Wins!"
                    : scores.player1 < scores.player2
                    ? "Player 2 Wins!"
                    : "It's a tie!";
            finalScore.textContent = `Player 1: ${scores.player1}, Player 2: ${scores.player2}. ${winner}`;
        }
    }

    function restartGame() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('landing-page').style.display = 'block';
        scores = { player1: 0, player2: 0 };
        round = 1;
        playerTurn = 1;
    }

    document.addEventListener('keydown', (event) => {
        if (event.key === 's' || event.key === 'S') {
            stopBar();
        }
    });

    // Initialise speed label on load
    updateSpeedLabel();
</script>

</body>
</html>